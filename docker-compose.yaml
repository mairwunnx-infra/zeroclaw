---
networks:
  infra:
x-backup-common-env: &backup-common-env
  TZ: ${TZ}
  AWS_ENDPOINT: ${AWS_ENDPOINT}
  AWS_ENDPOINT_PROTO: ${AWS_ENDPOINT_PROTO}
  AWS_S3_BUCKET_NAME: ${AWS_S3_BUCKET_NAME}
  AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
  AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
  BACKUP_CRON_EXPRESSION: ${BACKUP_CRON_EXPRESSION}
  BACKUP_RETENTION_DAYS: ${BACKUP_RETENTION_DAYS}
services:
  zeroclaw:
    image: ghcr.io/mairwunnx-infra/zeroclaw:0.1.0-1
    container_name: zeroclaw
    cpus: '1.0'
    restart: unless-stopped
    networks: [infra]
    environment:
      ZEROCLAW_API_KEY: ${ZEROCLAW_API_KEY}
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
      COMPOSIO_API_KEY: ${COMPOSIO_API_KEY}
      TZ: ${TZ}
    entrypoint:
      - /bin/sh
      - -ec
    command:
      - >-
        CONFIG="/home/zeroclaw/.zeroclaw/config.toml";
        escape_toml() { printf '%s' "$$1" | sed -e 's/\\/\\\\/g' -e 's/"/\\"/g'; };
        TG_ESCAPED="$$(escape_toml "$${TELEGRAM_BOT_TOKEN:-}")";
        COMPOSIO_ESCAPED="$$(escape_toml "$${COMPOSIO_API_KEY:-}")";
        TMP_CONFIG="$$(mktemp)";
        awk -v tg="$$TG_ESCAPED" -v comp="$$COMPOSIO_ESCAPED" '
        BEGIN { in_tg=0; in_comp=0 }
        /^\[channels_config\.telegram\]/ { in_tg=1; in_comp=0; print; next }
        /^\[composio\]/ { in_comp=1; in_tg=0; print; next }
        /^\[/ { in_tg=0; in_comp=0 }
        in_tg && /^allowed_users = \[[0-9]+\]/ { print "allowed_users = [\"362695653\"]"; next }
        in_tg && /^bot_token = / && tg != "" { print "bot_token = \"" tg "\""; next }
        in_comp && /^api_key = / && comp != "" { print "api_key = \"" comp "\""; next }
        { print }
        ' "$$CONFIG" > "$$TMP_CONFIG";
        mv "$$TMP_CONFIG" "$$CONFIG";
        exec zeroclaw daemon
    expose: ["3000"]
    volumes:
      - zeroclaw_data:/home/zeroclaw/.zeroclaw
    healthcheck:
      test: ["CMD", "zeroclaw", "status"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 20s
    logging:
      driver: local
      options:
        max-file: '3'
        max-size: 10m
    mem_limit: 128m
    mem_reservation: 64m
  backup-zeroclaw:
    image: offen/docker-volume-backup:v2
    container_name: backup-zeroclaw
    environment:
      <<: *backup-common-env
      AWS_S3_PATH: backups/${STACK_SLUG:-zeroclaw}/zeroclaw
      BACKUP_FILENAME: zeroclaw-%Y%m%dT%H%M%S.tar.gz
      BACKUP_PRUNING_PREFIX: zeroclaw-
    volumes:
      - zeroclaw_data:/backup/zeroclaw/data:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks: [infra]
    restart: unless-stopped
volumes:
  zeroclaw_data:
    driver: local